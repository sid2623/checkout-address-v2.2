<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
        }
        .sticky-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 1000;
            pointer-events: none;
        }
        .payment-option {
            transition: all 0.2s ease;
        }
        .payment-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .success-animation {
            animation: bounce 0.6s ease-in-out;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <!-- Page 1: Location Selection -->
    <div id="page1" class="page active min-h-full">
        <div class="bg-white shadow-sm">
            <div class="px-4 py-6">
                <h1 class="text-2xl font-bold text-gray-900 text-center">Delivery Location</h1>
                <p class="text-gray-600 text-center mt-2">Where should we deliver your order?</p>
            </div>
        </div>
        
        <div class="px-4 py-6 space-y-6">
            <!-- Search Bar -->
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search for your location..." 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <div id="searchResults" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg mt-1 max-h-48 overflow-y-auto hidden z-[9999] shadow-lg"></div>
            </div>
            
            <!-- Map Container -->
            <div class="relative">
                <div id="map" class="map-container"></div>
                <div class="sticky-pin">
                    <div class="text-3xl drop-shadow-lg">üìç</div>
                </div>
            </div>
            
            <!-- Current Location Button -->
            <button id="currentLocationBtn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                üìç Use Current Location
            </button>
            
            <!-- Location Details -->
            <div id="locationDetails" class="bg-white p-4 rounded-lg shadow-sm border hidden">
                <h3 class="font-semibold text-gray-900 mb-2">Delivery Location</h3>
                <p id="addressText" class="text-gray-600 mb-2"></p>
                <div class="text-sm text-gray-500 space-y-1">
                    <p>Coordinates: <span id="coordsText"></span></p>
                    <p>DigiPIN: <span id="digipinText" class="font-mono bg-gray-100 px-2 py-1 rounded"></span></p>
                </div>
            </div>
            
            <!-- Next Button -->
            <button id="nextBtn1" class="w-full bg-green-600 text-white py-4 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                Continue to Details ‚Üí
            </button>
        </div>
    </div>

    <!-- Page 2: User Details -->
    <div id="page2" class="page min-h-full">
        <div class="bg-white shadow-sm">
            <div class="px-4 py-6">
                <div class="flex justify-between items-center mb-4">
                    <button id="backBtn1" class="text-blue-600">‚Üê Back</button>
                    <button id="editAddressBtn" class="text-blue-600 text-sm">Edit Address</button>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 text-center">Delivery Details</h1>
            </div>
        </div>
        
        <div class="px-4 py-6 space-y-6">
            <!-- Location Summary -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-semibold text-blue-900 mb-2">Delivery Location</h3>
                <p id="summaryAddress" class="text-blue-800 text-sm mb-2"></p>
                <div class="text-xs text-blue-600 space-y-1">
                    <p>Coordinates: <span id="summaryCoords"></span></p>
                    <p>DigiPIN: <span id="summaryDigipin" class="font-mono"></span></p>
                </div>
            </div>
            
            <!-- User Details Form -->
            <div class="bg-white p-4 rounded-lg shadow-sm border space-y-4">
                <h3 class="font-semibold text-gray-900">Contact Information</h3>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Door/Flat Number (Optional)</label>
                    <input type="text" id="doorNo" placeholder="e.g., 4B, Flat 201" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                    <input type="text" id="userName" placeholder="Enter your full name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number *</label>
                    <input type="tel" id="userMobile" placeholder="Enter 10-digit mobile number" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            
            <!-- Order Summary -->
            <div id="orderSummary" class="bg-white p-4 rounded-lg shadow-sm border hidden">
                <h3 class="font-semibold text-gray-900 mb-3">Order Summary</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Name:</span>
                        <span id="summaryName" class="font-medium"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Mobile:</span>
                        <span id="summaryMobile" class="font-medium"></span>
                    </div>
                    <div class="flex justify-between items-start">
                        <span>Address:</span>
                        <span id="summaryFullAddress" class="font-medium text-right max-w-48"></span>
                    </div>
                </div>
            </div>
            
            <!-- Pay Now Button -->
            <button id="payNowBtn" class="w-full bg-green-600 text-white py-4 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                Proceed to Payment ‚Üí
            </button>
        </div>
    </div>

    <!-- Page 3: Payment Options -->
    <div id="page3" class="page min-h-full">
        <div class="bg-white shadow-sm">
            <div class="px-4 py-6">
                <div class="flex justify-between items-center mb-4">
                    <button id="backBtn2" class="text-blue-600">‚Üê Back</button>
                    <button id="editDetailsBtn" class="text-blue-600 text-sm">Edit Details</button>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 text-center">Payment</h1>
            </div>
        </div>
        
        <div class="px-4 py-6 space-y-6">
            <!-- Order Details -->
            <div class="bg-white p-4 rounded-lg shadow-sm border">
                <h3 class="font-semibold text-gray-900 mb-3">Order Details</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Sample Product</span>
                        <span>‚Çπ299</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Delivery Fee</span>
                        <span>‚Çπ49</span>
                    </div>
                    <div class="border-t pt-2 mt-2">
                        <div class="flex justify-between font-semibold">
                            <span>Total Amount</span>
                            <span>‚Çπ348</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Details Summary -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-gray-900 mb-2">Delivery Information</h3>
                <div id="finalUserDetails" class="text-sm text-gray-600 space-y-1"></div>
                <div class="text-xs text-gray-500 mt-3 space-y-1">
                    <div>Coordinates: <span id="finalCoords" class="font-mono"></span></div>
                    <div>DigiPIN: <span id="finalDigipin" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></div>
                </div>
            </div>
            
            <!-- Payment Options -->
            <div class="space-y-3">
                <h3 class="font-semibold text-gray-900">Choose Payment Method</h3>
                
                <div class="payment-option bg-white p-4 rounded-lg shadow-sm border cursor-pointer hover:border-blue-500" onclick="selectPayment('autopay')">
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="payment" value="autopay" class="text-blue-600">
                        <div>
                            <div class="font-medium">Debit on Pay (AutoPay)</div>
                            <div class="text-sm text-gray-600">One-time UPI mandate. Money debited at delivery</div>
                        </div>
                    </div>
                </div>
                
                <div class="payment-option bg-white p-4 rounded-lg shadow-sm border cursor-pointer hover:border-blue-500" onclick="selectPayment('upi')">
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="payment" value="upi" class="text-blue-600">
                        <div>
                            <div class="font-medium">UPI</div>
                            <div class="text-sm text-gray-600">Pay using any UPI app</div>
                        </div>
                    </div>
                </div>
                
                <div class="payment-option bg-white p-4 rounded-lg shadow-sm border cursor-pointer hover:border-blue-500" onclick="selectPayment('wallet')">
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="payment" value="wallet" class="text-blue-600">
                        <div>
                            <div class="font-medium">Wallets</div>
                            <div class="text-sm text-gray-600">Paytm, PhonePe, Google Pay wallet</div>
                        </div>
                    </div>
                </div>
                
                <div class="payment-option bg-white p-4 rounded-lg shadow-sm border cursor-pointer hover:border-blue-500" onclick="selectPayment('card')">
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="payment" value="card" class="text-blue-600">
                        <div>
                            <div class="font-medium">Debit/Credit Cards</div>
                            <div class="text-sm text-gray-600">Visa, Mastercard, RuPay</div>
                        </div>
                    </div>
                </div>
                
                <div class="payment-option bg-white p-4 rounded-lg shadow-sm border cursor-pointer hover:border-blue-500" onclick="selectPayment('netbanking')">
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="payment" value="netbanking" class="text-blue-600">
                        <div>
                            <div class="font-medium">Net Banking</div>
                            <div class="text-sm text-gray-600">All major banks supported</div>
                        </div>
                    </div>
                </div>
                
                <div class="payment-option bg-white p-4 rounded-lg shadow-sm border cursor-pointer hover:border-blue-500" onclick="selectPayment('cod')">
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="payment" value="cod" class="text-blue-600">
                        <div>
                            <div class="font-medium">Cash on Delivery</div>
                            <div class="text-sm text-gray-600">Pay when your order arrives</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Complete Payment Button -->
            <button id="completePaymentBtn" class="w-full bg-green-600 text-white py-4 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                Complete Payment
            </button>
        </div>
    </div>

    <!-- Page 4: Success -->
    <div id="page4" class="page min-h-full">
        <div class="flex flex-col items-center justify-center min-h-full px-4 py-12">
            <div class="text-center space-y-6">
                <div class="success-animation">
                    <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
                
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Order Confirmed!</h1>
                    <p class="text-gray-600">Thank you for your order. We'll deliver it soon!</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border max-w-sm mx-auto">
                    <h3 class="font-semibold text-gray-900 mb-3">Order Summary</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Order ID:</span>
                            <span class="font-mono">#ORD12345</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Amount:</span>
                            <span class="font-semibold">‚Çπ348</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Payment:</span>
                            <span id="selectedPaymentMethod" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Delivery:</span>
                            <span class="font-medium">30-45 mins</span>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <button class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        Track Your Order
                    </button>
                    <button onclick="startOver()" class="w-full bg-gray-200 text-gray-800 py-3 px-6 rounded-lg font-medium hover:bg-gray-300 transition-colors">
                        Place Another Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map, marker;
        let currentLat = 28.6139, currentLon = 77.2090; // Default to Delhi
        let currentAddress = '';
        let currentDigipin = '';
        let selectedPaymentMethod = '';

        // DigiPIN calculation function
        function Get_DIGIPIN(lat, lon) {
            var L=[
                ['F', 'C', '9', '8'],
                ['J', '3', '2', '7'],
                ['K', '4', '5', '6'],
                ['L', 'M', 'P', 'T']
            ];
            var vDIGIPIN = '';
            
            var row = 0; var column = 0;
            var MinLat = 2.5; var MaxLat = 38.50; var MinLon = 63.50; var MaxLon = 99.50;
            var LatDivBy = 4; var LonDivBy = 4;
            var LatDivDeg = 0; var LonDivDeg = 0;
            
            if (lat < MinLat || lat > MaxLat) {
                return 'Out of range';
            }
            if (lon < MinLon || lon > MaxLon) {
                return 'Out of range';
            }
            
            for (let Lvl = 1; Lvl <= 10; Lvl++) {
                LatDivDeg = (MaxLat - MinLat) / LatDivBy;
                LonDivDeg = (MaxLon - MinLon) / LonDivBy;
                var NextLvlMaxLat = MaxLat;
                var NextLvlMinLat = MaxLat - LatDivDeg;
                
                for (x = 0; x < LatDivBy; x++) {
                    if (lat >= NextLvlMinLat && lat < NextLvlMaxLat) {
                        row = x;
                        break;
                    }
                    else{
                        NextLvlMaxLat = NextLvlMinLat
                        NextLvlMinLat = NextLvlMaxLat - LatDivDeg;
                    } 
                }
                
                var NextLvlMinLon = MinLon;
                var NextLvlMaxLon = MinLon + LonDivDeg;
                for (x = 0; x < LonDivBy; x++) {
                    if (lon >= NextLvlMinLon && lon < NextLvlMaxLon) {
                        column = x;
                        break;
                    }
                    else if((NextLvlMinLon + LonDivDeg)<MaxLon){
                        NextLvlMinLon = NextLvlMaxLon;
                        NextLvlMaxLon = NextLvlMinLon + LonDivDeg;
                    }
                    else {
                        column=x;
                    }
                }
                
                if (Lvl == 1) {
                    if (L[row][column] == "0") {
                        vDIGIPIN = "Out of Bound";
                        break;
                    }
                }
                vDIGIPIN = vDIGIPIN + L[row][column];
                
                if (Lvl == 3 || Lvl == 6) {
                    vDIGIPIN = vDIGIPIN + "-"
                }
                
                MinLat = NextLvlMinLat; MaxLat = NextLvlMaxLat;
                MinLon = NextLvlMinLon; MaxLon = NextLvlMaxLon;
            }
            return vDIGIPIN;
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([currentLat, currentLon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // No marker needed - using emoji pin overlay
            
            // Update location when map is clicked
            map.on('click', function(e) {
                updateLocation(e.latlng.lat, e.latlng.lng);
            });

            // Update location when map is moved (center changes)
            map.on('moveend', function(e) {
                const center = map.getCenter();
                updateLocation(center.lat, center.lng);
            });

            updateLocation(currentLat, currentLon);
        }

        // Update location details
        async function updateLocation(lat, lon) {
            currentLat = lat;
            currentLon = lon;
            
            // Calculate DigiPIN
            currentDigipin = Get_DIGIPIN(lat, lon);
            
            // Reverse geocoding
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                const data = await response.json();
                currentAddress = data.display_name || 'Address not found';
            } catch (error) {
                currentAddress = 'Unable to fetch address';
            }
            
            // Update UI
            document.getElementById('coordsText').textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            document.getElementById('digipinText').textContent = currentDigipin;
            document.getElementById('addressText').textContent = currentAddress;
            document.getElementById('locationDetails').classList.remove('hidden');
            document.getElementById('nextBtn1').disabled = false;
        }

        // Search functionality
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 3) {
                document.getElementById('searchResults').classList.add('hidden');
                return;
            }
            
            // Show loading state
            document.getElementById('searchResults').innerHTML = '<div class="p-3 text-gray-500">Searching...</div>';
            document.getElementById('searchResults').classList.remove('hidden');
            
            searchTimeout = setTimeout(async () => {
                try {
                    // Use a more comprehensive search with better parameters
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=8&addressdetails=1&extratags=1&namedetails=1&bounded=0&dedupe=1`);
                    
                    if (!response.ok) {
                        throw new Error('Search service unavailable');
                    }
                    
                    const results = await response.json();
                    displaySearchResults(results);
                } catch (error) {
                    console.error('Search error:', error);
                    document.getElementById('searchResults').innerHTML = '<div class="p-3 text-red-500">Search failed. Please try again.</div>';
                    document.getElementById('searchResults').classList.remove('hidden');
                }
            }, 500);
        });

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = '<div class="p-3 text-gray-500">No results found. Try a different search term.</div>';
                container.classList.remove('hidden');
                return;
            }
            
            results.forEach((result, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0';
                
                // Create a more readable display name
                let displayName = result.display_name;
                if (result.address) {
                    const addr = result.address;
                    const parts = [];
                    if (addr.house_number && addr.road) parts.push(`${addr.house_number} ${addr.road}`);
                    else if (addr.road) parts.push(addr.road);
                    if (addr.suburb) parts.push(addr.suburb);
                    if (addr.city || addr.town || addr.village) parts.push(addr.city || addr.town || addr.village);
                    if (addr.state) parts.push(addr.state);
                    if (parts.length > 0) displayName = parts.join(', ');
                }
                
                div.innerHTML = `
                    <div class="font-medium text-gray-900">${displayName}</div>
                    <div class="text-xs text-gray-500 mt-1">${result.type || 'Location'}</div>
                `;
                
                div.onclick = () => {
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    if (isNaN(lat) || isNaN(lon)) {
                        console.error('Invalid coordinates');
                        return;
                    }
                    
                    map.setView([lat, lon], 16);
                    updateLocation(lat, lon);
                    document.getElementById('searchInput').value = displayName;
                    container.classList.add('hidden');
                };
                container.appendChild(div);
            });
            
            container.classList.remove('hidden');
        }

        // Current location
        document.getElementById('currentLocationBtn').addEventListener('click', function() {
            if (navigator.geolocation) {
                this.textContent = 'Getting location...';
                this.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        map.setView([lat, lon], 16);
                        updateLocation(lat, lon);
                        this.textContent = 'üìç Use Current Location';
                        this.disabled = false;
                    },
                    (error) => {
                        this.textContent = 'üìç Use Current Location';
                        this.disabled = false;
                        // Show inline error message instead of alert
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mt-2';
                        errorDiv.textContent = 'Unable to get your location. Please search manually or check location permissions.';
                        this.parentNode.insertBefore(errorDiv, this.nextSibling);
                        setTimeout(() => errorDiv.remove(), 5000);
                    }
                );
            }
        });

        // Page navigation
        function showPage(pageNum) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(`page${pageNum}`).classList.add('active');
        }

        // Page 1 to 2
        document.getElementById('nextBtn1').addEventListener('click', function() {
            // Update page 2 with location data
            document.getElementById('summaryAddress').textContent = currentAddress;
            document.getElementById('summaryCoords').textContent = `${currentLat.toFixed(6)}, ${currentLon.toFixed(6)}`;
            document.getElementById('summaryDigipin').textContent = currentDigipin;
            showPage(2);
        });

        // Back buttons
        document.getElementById('backBtn1').addEventListener('click', () => showPage(1));
        document.getElementById('backBtn2').addEventListener('click', () => showPage(2));

        // Form validation for page 2
        function validateForm() {
            const name = document.getElementById('userName').value.trim();
            const mobile = document.getElementById('userMobile').value.trim();
            const mobileRegex = /^[6-9]\d{9}$/;
            
            if (name && mobileRegex.test(mobile)) {
                updateOrderSummary();
                document.getElementById('payNowBtn').disabled = false;
            } else {
                document.getElementById('orderSummary').classList.add('hidden');
                document.getElementById('payNowBtn').disabled = false;
            }
        }

        function updateOrderSummary() {
            const name = document.getElementById('userName').value.trim();
            const mobile = document.getElementById('userMobile').value.trim();
            const doorNo = document.getElementById('doorNo').value.trim();
            
            const fullAddress = doorNo ? `${doorNo}, ${currentAddress}` : currentAddress;
            
            document.getElementById('summaryName').textContent = name;
            document.getElementById('summaryMobile').textContent = mobile;
            document.getElementById('summaryFullAddress').textContent = fullAddress;
            document.getElementById('orderSummary').classList.remove('hidden');
        }

        // Add event listeners for form fields
        document.getElementById('userName').addEventListener('input', validateForm);
        document.getElementById('userMobile').addEventListener('input', validateForm);
        document.getElementById('doorNo').addEventListener('input', validateForm);

        // Page 2 to 3
        document.getElementById('payNowBtn').addEventListener('click', function() {
            const name = document.getElementById('userName').value.trim();
            const mobile = document.getElementById('userMobile').value.trim();
            const doorNo = document.getElementById('doorNo').value.trim();
            const fullAddress = doorNo ? `${doorNo}, ${currentAddress}` : currentAddress;
            
            document.getElementById('finalUserDetails').innerHTML = `
                <div><strong>${name}</strong></div>
                <div>${mobile}</div>
                <div>${fullAddress}</div>
            `;
            document.getElementById('finalCoords').textContent = `${currentLat.toFixed(6)}, ${currentLon.toFixed(6)}`;
            document.getElementById('finalDigipin').textContent = currentDigipin;
            showPage(3);
        });

        // Edit buttons functionality
        document.getElementById('editAddressBtn').addEventListener('click', () => showPage(1));
        document.getElementById('editDetailsBtn').addEventListener('click', () => showPage(2));

        // Payment selection
        function selectPayment(method) {
            selectedPaymentMethod = method;
            document.querySelector(`input[value="${method}"]`).checked = true;
            document.getElementById('completePaymentBtn').disabled = false;
        }

        // Complete payment
        document.getElementById('completePaymentBtn').addEventListener('click', function() {
            const paymentNames = {
                'autopay': 'AutoPay',
                'upi': 'UPI',
                'wallet': 'Wallet',
                'card': 'Card',
                'netbanking': 'Net Banking',
                'cod': 'Cash on Delivery'
            };
            
            document.getElementById('selectedPaymentMethod').textContent = paymentNames[selectedPaymentMethod];
            showPage(4);
        });

        // Start over function
        function startOver() {
            // Reset all forms
            document.getElementById('searchInput').value = '';
            document.getElementById('doorNo').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('userMobile').value = '';
            document.getElementById('locationDetails').classList.add('hidden');
            document.getElementById('orderSummary').classList.add('hidden');
            document.getElementById('nextBtn1').disabled = true;
            document.getElementById('payNowBtn').disabled = true;
            document.getElementById('completePaymentBtn').disabled = true;
            
            // Reset payment selection
            document.querySelectorAll('input[name="payment"]').forEach(input => input.checked = false);
            selectedPaymentMethod = '';
            
            showPage(1);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Request location permission immediately
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLat = position.coords.latitude;
                        currentLon = position.coords.longitude;
                        initMap();
                    },
                    (error) => {
                        // If location access denied, use default location
                        initMap();
                    }
                );
            } else {
                initMap();
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#searchInput') && !e.target.closest('#searchResults')) {
                document.getElementById('searchResults').classList.add('hidden');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ee90460300c469',t:'MTc2MDUyMzQxMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
